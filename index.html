<!DOCTYPE html>
<html>
<head>
    <title>Update Acquisition Tasks</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #0073ea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        button:hover {
            background: #0060c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #tasksContainer {
            margin-top: 30px;
            display: none;
        }
        .category-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }
        .category-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0073ea;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .task-item:hover {
            background: #f0f7ff;
        }
        .task-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        .task-name {
            flex: 1;
            color: #333;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Update Acquisition Tasks</h2>
        
        <!-- Dropdown 1: Select Property -->
        <label for="propertySelect">1. Select Property:</label>
        <select id="propertySelect">
            <option value="">Loading properties...</option>
        </select>
        
        <!-- Dropdown 2: Select Checklist -->
        <label for="checklistSelect">2. Select Checklist:</label>
        <select id="checklistSelect" disabled>
            <option value="">First select a property...</option>
        </select>
        
        <div id="result"></div>
    </div>

    <!-- Tasks Container -->
    <div id="tasksContainer" class="form-container">
        <h3>Tasks</h3>
        <div id="tasksList"></div>
        <button id="saveBtn" onclick="saveTasks()">Save All Changes</button>
    </div>

    <script>
        // CONFIGURATION
        const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjYxMTQ4MzAxNiwiYWFpIjoxMSwidWlkIjo5ODE2NDg4MywiaWFkIjoiMjAyNi0wMS0yM1QxNDo0OTo1NC4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6MzMxNzQyNTYsInJnbiI6InVzZTEifQ.18JovTtUYM5Z7eg9IN8P0kzIYvW_fg2sWenkiV6Tzok';  // ⚠️ REPLACE WITH YOUR API KEY
        const BOARD_ID = '18401100872';
        
        const COLUMNS = {
            CHECKBOX: 'boolean_mm0tgjha',
            NOTES: 'long_text_mm0thdhe'
        };
        
        let allTasks = [];
        
        // Initialize
        window.addEventListener('load', loadProperties);
        document.getElementById('propertySelect').addEventListener('change', onPropertyChange);
        document.getElementById('checklistSelect').addEventListener('change', onChecklistChange);
        
        async function loadProperties() {
            const query = `
                query {
                    boards(ids: ${BOARD_ID}) {
                        items_page(limit: 50) {
                            items {
                                id
                                name
                            }
                        }
                    }
                }
            `;
            
            try {
                const response = await fetch('https://api.monday.com/v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });
                
                const data = await response.json();
                
                if (data.errors) {
                    showResult('Error: ' + data.errors[0].message, 'error');
                    return;
                }
                
                const properties = data.data.boards[0].items_page.items;
                const propertySelect = document.getElementById('propertySelect');
                propertySelect.innerHTML = '<option value="">Select a property...</option>';
                
                properties.forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop.id;
                    option.textContent = prop.name;
                    propertySelect.appendChild(option);
                });
                
            } catch (error) {
                showResult('Error: ' + error.message, 'error');
            }
        }
        
       async function onPropertyChange(e) {
    const propertyId = e.target.value;
    const checklistSelect = document.getElementById('checklistSelect');
    const tasksContainer = document.getElementById('tasksContainer');
    
    checklistSelect.innerHTML = '<option value="">Loading checklists...</option>';
    checklistSelect.disabled = true;
    tasksContainer.style.display = 'none';
    
    if (!propertyId) return;
    
    const query = `
        query {
            items(ids: [${propertyId}]) {
                id
                name
                subitems {
                    id
                    name
                }
            }
        }
    `;
    
    try {
        const response = await fetch('https://api.monday.com/v2', {
            method: 'POST',
            headers: {
                'Authorization': API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query })
        });
        
        const data = await response.json();
        
        if (data.errors) {
            showResult('Error: ' + data.errors[0].message, 'error');
            return;
        }
        
        const allSubitems = data.data.items[0].subitems;
        
        // SMART FILTER: Look for items that are likely checklists
        // Based on your board: "Transition To Ops", "DD (copy)", "Underwriting (copy)", etc.
        const potentialChecklists = allSubitems.filter(item => 
            item.name.includes('(copy)') || 
            item.name === 'Transition To Ops' ||
            item.name === 'DD' ||
            item.name === 'Underwriting' ||
            item.name === 'Close out' ||
            item.name.match(/^[A-Z][a-z]+\s+(To|&)/) // Matches "Transition To" or "Title &"
        );
        
        console.log('Filtered to potential checklists:', potentialChecklists.length);
        console.log('Names:', potentialChecklists.map(c => c.name));
        
        // Now check only these for subitems
        const checklists = [];
        
        for (const item of potentialChecklists) {
            const checkQuery = `
                query {
                    items(ids: [${item.id}]) {
                        id
                        name
                        subitems {
                            id
                        }
                    }
                }
            `;
            
            const checkResponse = await fetch('https://api.monday.com/v2', {
                method: 'POST',
                headers: {
                    'Authorization': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: checkQuery })
            });
            
            const checkData = await checkResponse.json();
            
            if (checkData.data.items[0].subitems && checkData.data.items[0].subitems.length > 0) {
                checklists.push(item);
            }
        }
        
        console.log('FOUND CHECKLISTS:', checklists);
        
        checklistSelect.innerHTML = '<option value="">Select a checklist...</option>';
        
        if (checklists.length > 0) {
            checklistSelect.disabled = false;
            checklists.forEach(checklist => {
                const option = document.createElement('option');
                option.value = checklist.id;
                option.textContent = checklist.name.replace(' (copy)', '');
                checklistSelect.appendChild(option);
            });
        } else {
            checklistSelect.innerHTML = '<option value="">No checklists found</option>';
        }
        
    } catch (error) {
        showResult('Error: ' + error.message, 'error');
    }
}
        
        async function onChecklistChange(e) {
    const checklistId = e.target.value;
    const tasksContainer = document.getElementById('tasksContainer');
    const tasksList = document.getElementById('tasksList');
    
    if (!checklistId) {
        tasksContainer.style.display = 'none';
        return;
    }
    
    tasksList.innerHTML = '<div class="loading">Loading tasks...</div>';
    tasksContainer.style.display = 'block';
    
    // FIXED: First get the checklist's subitems (categories - Level 2)
    const checklistQuery = `
        query {
            items(ids: [${checklistId}]) {
                id
                name
                subitems {
                    id
                    name
                }
            }
        }
    `;
    
    try {
        const checklistResponse = await fetch('https://api.monday.com/v2', {
            method: 'POST',
            headers: {
                'Authorization': API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: checklistQuery })
        });
        
        const checklistData = await checklistResponse.json();
        
        if (checklistData.errors) {
            showResult('Error: ' + checklistData.errors[0].message, 'error');
            return;
        }
        
        const categories = checklistData.data.items[0].subitems;
        
        if (!categories || categories.length === 0) {
            tasksList.innerHTML = '<p>No categories found in this checklist.</p>';
            return;
        }
        
        // Now get tasks for each category (Level 3)
        let html = '';
        allTasks = [];
        
        for (const category of categories) {
            const categoryQuery = `
                query {
                    items(ids: [${category.id}]) {
                        id
                        name
                        subitems {
                            id
                            name
                            column_values {
                                id
                                value
                            }
                        }
                    }
                }
            `;
            
            const categoryResponse = await fetch('https://api.monday.com/v2', {
                method: 'POST',
                headers: {
                    'Authorization': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: categoryQuery })
            });
            
            const categoryData = await categoryResponse.json();
            
            if (categoryData.errors) continue;
            
            const tasks = categoryData.data.items[0].subitems;
            
            if (tasks && tasks.length > 0) {
                html += `
                    <div class="category-section">
                        <div class="category-title">${category.name}</div>
                `;
                
                tasks.forEach(task => {
                    const checkboxColumn = task.column_values.find(cv => cv.id === COLUMNS.CHECKBOX);
                    const isChecked = checkboxColumn && checkboxColumn.value ? JSON.parse(checkboxColumn.value).checked : false;
                    
                    allTasks.push({
                        id: task.id,
                        name: task.name,
                        category: category.name,
                        checked: isChecked
                    });
                    
                    html += `
                        <div class="task-item">
                            <input type="checkbox" 
                                   class="task-checkbox" 
                                   data-task-id="${task.id}"
                                   ${isChecked ? 'checked' : ''}>
                            <span class="task-name">${task.name}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
        }
        
        tasksList.innerHTML = html || '<p>No tasks found in this checklist.</p>';
        
    } catch (error) {
        showResult('Error: ' + error.message, 'error');
    }
}
        
        async function saveTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            const saveBtn = document.getElementById('saveBtn');
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                for (const checkbox of checkboxes) {
                    const taskId = checkbox.dataset.taskId;
                    const isChecked = checkbox.checked;
                    
                    const query = `
                        mutation {
                            change_simple_column_value(
                                item_id: ${taskId},
                                board_id: ${BOARD_ID},
                                column_id: "${COLUMNS.CHECKBOX}",
                                value: ${JSON.stringify(JSON.stringify({ checked: isChecked }))}
                            ) {
                                id
                            }
                        }
                    `;
                    
                    await fetch('https://api.monday.com/v2', {
                        method: 'POST',
                        headers: {
                            'Authorization': API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });
                }
                
                showResult('✅ All tasks updated successfully!', 'success');
                
            } catch (error) {
                showResult('Error: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save All Changes';
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = type;
            resultDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
