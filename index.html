<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acquisition Checklist Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f6f8;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #323338;
            margin-bottom: 30px;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323338;
        }
        select, input[type="date"], input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #c5c7d0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #0073ea;
        }
        .auto-save-notice {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
            font-size: 14px;
        }
        .progress-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .task-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .task-card.completed {
            background: #f1f8f4;
            border-color: #4caf50;
        }
        .task-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .task-name {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
            color: #323338;
        }
        .completion-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-complete {
            background: #4caf50;
            color: white;
        }
        .badge-progress {
            background: #ff9800;
            color: white;
        }
        .badge-not-started {
            background: #757575;
            color: white;
        }
        .field-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .field-group {
            margin-bottom: 15px;
        }
        .field-group label {
            font-size: 13px;
            color: #676879;
            margin-bottom: 6px;
        }
        .existing-files {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .file-link {
            display: block;
            color: #0073ea;
            text-decoration: none;
            padding: 4px 0;
            font-size: 13px;
        }
        .file-link:hover {
            text-decoration: underline;
        }
        .saving-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            font-weight: bold;
            font-size: 14px;
        }
        .saving {
            background: #ff9800;
            color: white;
            display: block;
        }
        .saved {
            background: #4caf50;
            color: white;
            display: block;
        }
        .error {
            background: #f44336;
            color: white;
            display: block;
        }
        .category-section {
            margin-bottom: 30px;
        }
        .category-title {
            font-size: 18px;
            font-weight: bold;
            color: #0073ea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0073ea;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="savingIndicator" class="saving-indicator"></div>
    
    <div class="container">
        <h1>üìã Acquisition Checklist</h1>
        
        <div class="form-container">
            <div class="auto-save-notice">
                <strong>üí° Auto-Save Enabled:</strong> All changes are saved automatically in real-time!
            </div>
            
            <div class="form-group">
                <label for="property">1. Select Property</label>
                <select id="property" onchange="onPropertyChange()">
                    <option value="">-- Select Property --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="checklist">2. Select Checklist</label>
                <select id="checklist" onchange="onChecklistChange()" disabled>
                    <option value="">-- Select Checklist --</option>
                </select>
            </div>
        </div>
        
        <div id="progressSection" style="display: none;">
            <div class="form-container progress-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">Overall Progress</h3>
                    <button onclick="onChecklistChange()" style="padding: 8px 16px; background: #0073ea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üîÑ Refresh Tasks
                    </button>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">0%</div>
                </div>
                <p id="progressText" style="text-align: center; margin-top: 10px; font-weight: bold; color: #666;"></p>
            </div>
        </div>
        
        <div id="tasksContainer"></div>
    </div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjYxMTQ4MzAxNiwiYWFpIjoxMSwidWlkIjo5ODE2NDg4MywiaWFkIjoiMjAyNi0wMS0yM1QxNDo0OTo1NC4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6MzMxNzQyNTYsInJnbiI6InVzZTEifQ.18JovTtUYM5Z7eg9IN8P0kzIYvW_fg2sWenkiV6Tzok';
        const BOARD_ID = '18401100872';
        
        const COLUMNS = {
            STATUS: 'color_mm0vqagx',
            RECEIVED_DOCS: 'color_mm0vj45d',
            DUE_DATE: 'date_mm0vrtb5',
            DAYS_REMAINING: 'numeric_mm0vy3h7',
            COMPLETION_DATE: 'date_mm0v5fwx',
            RESPONSIBILITY: 'multiple_person_mm0t72ab',
            FILES: 'file_mm0t6adw',
            COMMENTS: 'long_text_mm0thdhe'
        };
        
        const CHECKLIST_FIELDS = {
            'Transition To Ops': ['STATUS', 'DUE_DATE', 'RESPONSIBILITY', 'FILES', 'COMMENTS'],
            'DD (copy)': ['STATUS', 'RESPONSIBILITY', 'RECEIVED_DOCS', 'COMPLETION_DATE', 'COMMENTS', 'FILES'],
            'Due Diligence': ['STATUS', 'RESPONSIBILITY', 'RECEIVED_DOCS', 'COMPLETION_DATE', 'COMMENTS', 'FILES'],
            'Close out': ['DUE_DATE', 'DAYS_REMAINING', 'COMPLETION_DATE', 'RESPONSIBILITY', 'FILES', 'COMMENTS']
        };
        
        let currentChecklistType = '';
        let teamMembers = [];
        let commentTimers = {};
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        function showSavingIndicator(status, message) {
            const indicator = document.getElementById('savingIndicator');
            indicator.className = 'saving-indicator ' + status;
            indicator.textContent = message;
            
            if (status === 'saved' || status === 'error') {
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        async function mondayAPI(query, variables = {}) {
            const response = await fetch('https://api.monday.com/v2', {
                method: 'POST',
                headers: {
                    'Authorization': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query, variables })
            });
            return response.json();
        }
        
        async function loadProperties() {
            try {
                const query = `
                    query {
                        boards(ids: ${BOARD_ID}) {
                            items_page(limit: 10) {
                                items {
                                    id
                                    name
                                }
                            }
                        }
                    }
                `;
                
                const data = await mondayAPI(query);
                const properties = data.data.boards[0].items_page.items;
                
                const propertySelect = document.getElementById('property');
                properties.forEach(prop => {
                    const option = document.createElement('option');
                    option.value = prop.id;
                    option.textContent = prop.name;
                    propertySelect.appendChild(option);
                });
                
                await loadTeamMembers();
                
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadTeamMembers() {
            try {
                const query = `
                    query {
                        users {
                            id
                            name
                        }
                    }
                `;
                
                const data = await mondayAPI(query);
                teamMembers = data.data.users;
            } catch (error) {
                console.error('Error loading team members:', error);
            }
        }
        
        async function onPropertyChange() {
            const propertyId = document.getElementById('property').value;
            const checklistSelect = document.getElementById('checklist');
            
            checklistSelect.innerHTML = '<option value="">-- Select Checklist --</option>';
            checklistSelect.disabled = !propertyId;
            document.getElementById('tasksContainer').innerHTML = '';
            document.getElementById('progressSection').style.display = 'none';
            
            if (!propertyId) return;
            
            try {
                const query = `
                    query {
                        items(ids: [${propertyId}]) {
                            subitems {
                                id
                                name
                                subitems {
                                    id
                                    name
                                    subitems {
                                        id
                                    }
                                }
                            }
                        }
                    }
                `;
                
                const data = await mondayAPI(query);
                const items = data.data.items[0].subitems;
                
                const checklists = items.filter(item => {
                    if (!item.subitems || item.subitems.length === 0) return false;
                    return item.subitems.some(sub => sub.subitems && sub.subitems.length > 0);
                });
                
                checklists.forEach(checklist => {
                    const option = document.createElement('option');
                    option.value = checklist.id;
                    option.textContent = checklist.name;
                    checklistSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading checklists:', error);
            }
        }
        
        async function onChecklistChange() {
            const checklistId = document.getElementById('checklist').value;
            if (!checklistId) {
                document.getElementById('tasksContainer').innerHTML = '';
                document.getElementById('progressSection').style.display = 'none';
                return;
            }
            
            const checklistName = document.getElementById('checklist').options[document.getElementById('checklist').selectedIndex].text;
            currentChecklistType = checklistName;
            
            await loadTasks(checklistId);
        }
        
        async function loadTasks(checklistId) {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '<div class="loading">Loading tasks...</div>';
            
            try {
                const query = `
                    query {
                        items(ids: [${checklistId}]) {
                            subitems {
                                id
                                name
                            }
                        }
                    }
                `;
                
                const data = await mondayAPI(query);
                const categories = data.data.items[0].subitems;
                
                if (!categories || categories.length === 0) {
                    container.innerHTML = '<div class="loading">No categories found.</div>';
                    return;
                }
                
                const categoryIds = categories.map(c => c.id).join(',');
                
                const tasksQuery = `
                    query {
                        items(ids: [${categoryIds}]) {
                            id
                            name
                            subitems {
                                id
                                name
                                column_values {
                                    id
                                    value
                                    text
                                    type
                                }
                            }
                        }
                    }
                `;
                
                const tasksData = await mondayAPI(tasksQuery);
                displayTasks(tasksData.data.items);
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<div class="loading">Error loading tasks.</div>';
            }
        }
        
        function displayTasks(categories) {
            const container = document.getElementById('tasksContainer');
            let html = '';
            let totalTasks = 0;
            let completedTasks = 0;
            
            categories.forEach(category => {
                if (!category.subitems || category.subitems.length === 0) return;
                
                html += `<div class="category-section">`;
                html += `<div class="category-title">${category.name.replace(' (copy)', '')}</div>`;
                
                category.subitems.forEach(task => {
                    totalTasks++;
                    
                    const statusCol = task.column_values.find(cv => cv.id === COLUMNS.STATUS);
                    const statusValue = statusCol && statusCol.value ? JSON.parse(statusCol.value) : null;
                    const status = statusValue ? statusValue.label || '' : '';
                    const isComplete = status.toLowerCase().includes('complete');
                    
                    if (isComplete) completedTasks++;
                    
                    const responsibilityCol = task.column_values.find(cv => cv.id === COLUMNS.RESPONSIBILITY);
                    const receivedDocsCol = task.column_values.find(cv => cv.id === COLUMNS.RECEIVED_DOCS);
                    const dueDateCol = task.column_values.find(cv => cv.id === COLUMNS.DUE_DATE);
                    const completionDateCol = task.column_values.find(cv => cv.id === COLUMNS.COMPLETION_DATE);
                    const daysRemainingCol = task.column_values.find(cv => cv.id === COLUMNS.DAYS_REMAINING);
                    const filesCol = task.column_values.find(cv => cv.id === COLUMNS.FILES);
                    const commentsCol = task.column_values.find(cv => cv.id === COLUMNS.COMMENTS);
                    
                    const badgeClass = isComplete ? 'badge-complete' : (status.toLowerCase().includes('progress') ? 'badge-progress' : 'badge-not-started');
                    const badgeText = isComplete ? '‚úì Complete' : (status ? status : 'Not Started');
                    
                    html += `
                        <div class="task-card ${isComplete ? 'completed' : ''}" data-task-id="${task.id}">
                            <div class="task-header">
                                <div class="task-name">${task.name}</div>
                                <div class="completion-badge ${badgeClass}">${badgeText}</div>
                            </div>
                    `;
                    
                    const fields = CHECKLIST_FIELDS[currentChecklistType] || [];
                    
                    html += `<div class="field-row">`;
                    
                    if (fields.includes('STATUS')) {
                        html += `
                            <div class="field-group">
                                <label>Status</label>
                                <select onchange="updateStatus('${task.id}', this.value)">
                                    <option value="">-- Select --</option>
                                    <option value="Not Started" ${status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                    <option value="In Progress" ${status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Complete" ${status === 'Complete' ? 'selected' : ''}>Complete</option>
                                    <option value="Blocked" ${status === 'Blocked' ? 'selected' : ''}>Blocked</option>
                                </select>
                            </div>
                        `;
                    }
                    
                    if (fields.includes('RECEIVED_DOCS')) {
                        const receivedValue = receivedDocsCol && receivedDocsCol.value ? JSON.parse(receivedDocsCol.value).label || '' : '';
                        html += `
                            <div class="field-group">
                                <label>Received Docs</label>
                                <select onchange="updateReceivedDocs('${task.id}', this.value)">
                                    <option value="">-- Select --</option>
                                    <option value="Yes" ${receivedValue === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${receivedValue === 'No' ? 'selected' : ''}>No</option>
                                    <option value="N/A" ${receivedValue === 'N/A' ? 'selected' : ''}>N/A</option>
                                </select>
                            </div>
                        `;
                    }
                    
                    if (fields.includes('DUE_DATE')) {
                        const dueDate = dueDateCol && dueDateCol.value ? JSON.parse(dueDateCol.value).date || '' : '';
                        html += `
                            <div class="field-group">
                                <label>Due Date</label>
                                <input type="date" value="${dueDate}" onchange="updateDate('${task.id}', '${COLUMNS.DUE_DATE}', this.value)">
                            </div>
                        `;
                    }
                    
                    if (fields.includes('COMPLETION_DATE')) {
                        const compDate = completionDateCol && completionDateCol.value ? JSON.parse(completionDateCol.value).date || '' : '';
                        html += `
                            <div class="field-group">
                                <label>Completion Date</label>
                                <input type="date" value="${compDate}" onchange="updateDate('${task.id}', '${COLUMNS.COMPLETION_DATE}', this.value)">
                            </div>
                        `;
                    }
                    
                    if (fields.includes('DAYS_REMAINING')) {
                        const daysValue = daysRemainingCol && daysRemainingCol.text ? daysRemainingCol.text : '0';
                        html += `
                            <div class="field-group">
                                <label>Days Remaining</label>
                                <input type="number" value="${daysValue}" readonly style="background: #f5f5f5;">
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    
                    if (fields.includes('RESPONSIBILITY')) {
                        const assignedPeople = responsibilityCol && responsibilityCol.value ? JSON.parse(responsibilityCol.value).personsAndTeams || [] : [];
                        const assignedIds = assignedPeople.map(p => p.id);
                        
                        html += `
                            <div class="field-group">
                                <label>Assigned Responsibility</label>
                                <select multiple onchange="updatePeople('${task.id}', this)" style="height: 100px;">
                                    ${teamMembers.map(member => `
                                        <option value="${member.id}" ${assignedIds.includes(member.id) ? 'selected' : ''}>
                                            ${member.name}
                                        </option>
                                    `).join('')}
                                </select>
                                <small style="color: #666;">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                        `;
                    }
                    
                    if (fields.includes('COMMENTS')) {
                        const comments = commentsCol && commentsCol.value ? JSON.parse(commentsCol.value) : '';
                        html += `
                            <div class="field-group">
                                <label>Comments</label>
                                <textarea rows="3" oninput="debouncedUpdateComments('${task.id}', this.value)">${comments}</textarea>
                            </div>
                        `;
                    }
                    
                    if (fields.includes('FILES')) {
                        const files = filesCol && filesCol.value ? JSON.parse(filesCol.value).files || [] : [];
                        
                        if (files.length > 0) {
                            html += `
                                <div class="field-group">
                                    <label>Existing Files</label>
                                    <div class="existing-files">
                                        ${files.map(file => `<a href="${file.url}" target="_blank" class="file-link">üìé ${file.name}</a>`).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `
                            <div class="field-group">
                                <label>Upload ${files.length > 0 ? 'Additional' : ''} File</label>
                                <input type="file" onchange="uploadFile('${task.id}', this)">
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html || '<div class="loading">No tasks found.</div>';
            
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressFill').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${completedTasks} of ${totalTasks} tasks completed`;
        }
        
        async function updateStatus(taskId, status) {
            if (!status) return;
            
            showSavingIndicator('saving', 'üíæ Saving...');
            
            try {
                const query = `
                    mutation {
                        change_simple_column_value(
                            item_id: ${taskId},
                            board_id: ${BOARD_ID},
                            column_id: "${COLUMNS.STATUS}",
                            value: ${JSON.stringify(JSON.stringify({ label: status }))}
                        ) {
                            id
                        }
                    }
                `;
                
                await mondayAPI(query);
                showSavingIndicator('saved', '‚úÖ Saved!');
                
                // Update UI locally instead of reloading
                updateTaskBadge(taskId, status);
                updateProgress();
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Save failed');
                console.error(error);
            }
        }
        
        function updateTaskBadge(taskId, status) {
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskCard) return;
            
            const isComplete = status.toLowerCase().includes('complete');
            const badge = taskCard.querySelector('.completion-badge');
            
            if (isComplete) {
                taskCard.classList.add('completed');
                badge.className = 'completion-badge badge-complete';
                badge.textContent = '‚úì Complete';
            } else if (status.toLowerCase().includes('progress')) {
                taskCard.classList.remove('completed');
                badge.className = 'completion-badge badge-progress';
                badge.textContent = status;
            } else {
                taskCard.classList.remove('completed');
                badge.className = 'completion-badge badge-not-started';
                badge.textContent = status || 'Not Started';
            }
        }
        
        function updateProgress() {
            const allCards = document.querySelectorAll('.task-card');
            const completedCards = document.querySelectorAll('.task-card.completed');
            
            const total = allCards.length;
            const completed = completedCards.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressFill').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} tasks completed`;
        }
        
        async function updateReceivedDocs(taskId, value) {
            if (!value) return;
            
            showSavingIndicator('saving', 'üíæ Saving...');
            
            try {
                const query = `
                    mutation {
                        change_simple_column_value(
                            item_id: ${taskId},
                            board_id: ${BOARD_ID},
                            column_id: "${COLUMNS.RECEIVED_DOCS}",
                            value: ${JSON.stringify(JSON.stringify({ label: value }))}
                        ) {
                            id
                        }
                    }
                `;
                
                await mondayAPI(query);
                showSavingIndicator('saved', '‚úÖ Saved!');
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Save failed');
                console.error(error);
            }
        }
        
        async function updateDate(taskId, columnId, date) {
            if (!date) return;
            
            showSavingIndicator('saving', 'üíæ Saving...');
            
            try {
                const query = `
                    mutation {
                        change_simple_column_value(
                            item_id: ${taskId},
                            board_id: ${BOARD_ID},
                            column_id: "${columnId}",
                            value: ${JSON.stringify(JSON.stringify({ date: date }))}
                        ) {
                            id
                        }
                    }
                `;
                
                await mondayAPI(query);
                showSavingIndicator('saved', '‚úÖ Saved!');
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Save failed');
                console.error(error);
            }
        }
        
        async function updatePeople(taskId, selectElement) {
            const selectedOptions = Array.from(selectElement.selectedOptions);
            const personIds = selectedOptions.map(opt => parseInt(opt.value));
            
            showSavingIndicator('saving', 'üíæ Saving...');
            
            try {
                const value = {
                    personsAndTeams: personIds.map(id => ({ id, kind: "person" }))
                };
                
                const query = `
                    mutation {
                        change_simple_column_value(
                            item_id: ${taskId},
                            board_id: ${BOARD_ID},
                            column_id: "${COLUMNS.RESPONSIBILITY}",
                            value: ${JSON.stringify(JSON.stringify(value))}
                        ) {
                            id
                        }
                    }
                `;
                
                await mondayAPI(query);
                showSavingIndicator('saved', '‚úÖ Saved!');
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Save failed');
                console.error(error);
            }
        }
        
        async function updateComments(taskId, comments) {
            showSavingIndicator('saving', 'üíæ Saving...');
            
            try {
                const query = `
                    mutation {
                        change_simple_column_value(
                            item_id: ${taskId},
                            board_id: ${BOARD_ID},
                            column_id: "${COLUMNS.COMMENTS}",
                            value: ${JSON.stringify(JSON.stringify(comments))}
                        ) {
                            id
                        }
                    }
                `;
                
                await mondayAPI(query);
                showSavingIndicator('saved', '‚úÖ Saved!');
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Save failed');
                console.error(error);
            }
        }
        
        // Debounced version - waits 1.5 seconds after typing stops
        const debouncedUpdateComments = (taskId, comments) => {
            if (commentTimers[taskId]) {
                clearTimeout(commentTimers[taskId]);
            }
            
            commentTimers[taskId] = setTimeout(() => {
                updateComments(taskId, comments);
            }, 1500);
        };
        
        async function uploadFile(taskId, fileInput) {
            if (!fileInput.files || fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            showSavingIndicator('saving', 'üíæ Uploading file...');
            
            try {
                const formData = new FormData();
                
                const query = `
                    mutation($file: File!) {
                        add_file_to_column(
                            item_id: ${taskId},
                            column_id: "${COLUMNS.FILES}",
                            file: $file
                        ) {
                            id
                        }
                    }
                `;
                
                formData.append('query', query);
                formData.append('variables[file]', file);
                
                const response = await fetch('https://api.monday.com/v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': API_KEY
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.errors) {
                    showSavingIndicator('error', '‚ùå Upload failed');
                } else {
                    showSavingIndicator('saved', '‚úÖ File uploaded!');
                    fileInput.value = '';
                    // Just show success, don't reload (user can refresh to see new file)
                }
                
            } catch (error) {
                showSavingIndicator('error', '‚ùå Upload failed');
                console.error(error);
            }
        }
        
        window.addEventListener('load', loadProperties);
    </script>
</body>
</html>
